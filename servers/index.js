const express = require("express")
const app = express()
const cors = require('cors');

const { exec } = require('child_process');
const fs = require("fs")

const randomstring = require("randomstring");

const fileUpload = require('express-fileupload');

app.use(cors())
app.use(fileUpload())

app.get("/api", (req, res) => {
    res.json({"code": "404", "error": "Request not found"})
    console.log("wasa " + req.body)
})

app.post("/api/upload", (req, res) => {
    
    const file = req.files.filename;

    if (!file) {
        return res.status(400).send('No files were uploaded.');
    }

    var folder = randomstring.generate()
    if (!fs.existsSync(`MCAntiMalware/all/${folder}`)) {
        fs.mkdirSync(`MCAntiMalware/all/${folder}`)
    } else {
        return res.status(409).res.send({ success: false, message: "Folder already exist. Try again" })
    }

    file.mv(`MCAntiMalware/all/${folder}/${file.name}`, (err) => {
        if (err) {
            console.log(err)
            return res.status(500).send(err);
        }
    })

    exec(`java -jar MCAntiMalware/MCAntiMalware.jar --scanDirectory "MCAntiMalware/all/${folder}" --singleScan true --dontLogINFOCR true --disableAutoUpdate true --printNotInfectedMessages false"`, (stdout, stderr) => {

        var rule = /^\[AntiMalware\] \[[0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2}\] /gm
        var resp = stderr.replace(rule, "")
    
        rule = RegExp(`MCAntiMalware\\\\all\\\\${folder}\\\\`, "g")
        resp = resp.replace(rule, "")
        console.log(stderr)
        return res.send({ success: true, message: resp })

        
    })
    //var resp = "[AntiMalware] [18:02:38] [INFO]: Using locale en\r\n[AntiMalware] [18:02:38] [INFO]: Initializing\r\n[AntiMalware] [18:02:39] [INFO]: Any bugs and/or false-positives should be reported either on the GitHub repo, plugin discussion page, or on the discord server\r\n[AntiMalware] [18:02:38] [INFO]: Registering checks\r\n[AntiMalware] [18:02:38] [INFO]: Finished registering checks\r\n[AntiMalware] [18:02:38] [INFO]: Started scanning for malicious plugins\r\n[AntiMalware] [18:02:41] [DETECTED]: MCAntiMalware\\all\\J9Xe7hgY6KpTN4eCEyp1Az8rznraU19p\\FlamePaper.jar MIGHT be infected with Spigot.MALWARE.ForceOP.A Class Path: org/bukkit/command/defaults/OpCommand ; SourceFile/Line OpCommand.java/36\r\n[AntiMalware] [18:02:41] [DETECTED]: MCAntiMalware\\all\\J9Xe7hgY6KpTN4eCEyp1Az8rznraU19p\\FlamePaper.jar MIGHT be infected with Spigot.MALWARE.ForceOP.D Class Path: net/minecraft/server/v1_8_R3/PlayerList ; SourceFile/Line PlayerList.java/1\r\nRemaining files to scan: 0"
    


    /*var rule = /^\[AntiMalware\] \[[0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2}\] /gm
    resp = resp.replace(rule, "")

    rule = RegExp(`MCAntiMalware/all/${folder}`, "g")
    resp = resp.replace(rule, "")

    return res.send({success: true, message: resp})*/
})

app.listen(80, () => {
    console.log("Server started at port 80")
})